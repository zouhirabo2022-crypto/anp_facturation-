[INFO] Scanning for projects...
[INFO] 
[INFO] ----------------< org.example:anp-facturation-backend >-----------------
[INFO] Building anp-facturation-backend 0.0.1-SNAPSHOT
[INFO]   from pom.xml
[INFO] --------------------------------[ jar ]---------------------------------
[INFO] 
[INFO] --- resources:3.3.1:resources (default-resources) @ anp-facturation-backend ---
[INFO] Copying 2 resources from src\main\resources to target\classes
[INFO] Copying 3 resources from src\main\resources to target\classes
[INFO] 
[INFO] --- compiler:3.14.1:compile (default-compile) @ anp-facturation-backend ---
[INFO] Nothing to compile - all classes are up to date.
[INFO] 
[INFO] --- resources:3.3.1:testResources (default-testResources) @ anp-facturation-backend ---
[INFO] Copying 2 resources from src\test\resources to target\test-classes
[INFO] 
[INFO] --- compiler:3.14.1:testCompile (default-testCompile) @ anp-facturation-backend ---
[INFO] Nothing to compile - all classes are up to date.
[INFO] 
[INFO] --- surefire:3.5.4:test (default-test) @ anp-facturation-backend ---
[INFO] Using auto detected provider org.apache.maven.surefire.junitplatform.JUnitPlatformProvider
[INFO] 
[INFO] -------------------------------------------------------
[INFO]  T E S T S
[INFO] -------------------------------------------------------
[INFO] Running org.anpfacturationbackend.controller.AuthControllerIntegrationTest
16:45:38.455 [main] INFO org.springframework.test.context.support.AnnotationConfigContextLoaderUtils -- Could not detect default configuration classes for test class [org.anpfacturationbackend.controller.AuthControllerIntegrationTest]: AuthControllerIntegrationTest does not declare any static, non-private, non-final, nested classes annotated with @Configuration.
16:45:39.137 [main] INFO org.springframework.boot.test.context.SpringBootTestContextBootstrapper -- Found @SpringBootConfiguration org.anpfacturationbackend.AnpFacturationBackendApplication for test class org.anpfacturationbackend.controller.AuthControllerIntegrationTest

  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/

 :: Spring Boot ::               (v3.5.10)

Hibernate: drop table if exists app_users cascade 
Hibernate: drop table if exists audit_log cascade 
Hibernate: drop table if exists bulletins cascade 
Hibernate: drop table if exists client cascade 
Hibernate: drop table if exists facture cascade 
Hibernate: drop table if exists ligne_facture cascade 
Hibernate: drop table if exists lignes_bulletin cascade 
Hibernate: drop table if exists prestations cascade 
Hibernate: drop table if exists roles cascade 
Hibernate: drop table if exists tarifs_autorisation cascade 
Hibernate: drop table if exists tarifs_concession cascade 
Hibernate: drop table if exists tarifs_eau_electricite cascade 
Hibernate: drop table if exists tarifs_otdp cascade 
Hibernate: drop table if exists user_roles cascade 
Hibernate: create table app_users (enabled boolean not null, password varchar(255) not null, username varchar(255) not null, primary key (username))
Hibernate: create table audit_log (id bigint generated by default as identity, timestamp timestamp(6) not null, action varchar(255) not null, details TEXT, ip_address varchar(255), username varchar(255) not null, primary key (id))
Hibernate: create table bulletins (client_id bigint not null, date_reception timestamp(6) not null, id bigint generated by default as identity, id_bulletin_metier varchar(255) unique, periode_facturation varchar(255), statut enum ('EN_ATTENTE','REJETE','TRAITE') not null, primary key (id))
Hibernate: create table client (id bigint generated by default as identity, adresse varchar(255) not null, email varchar(255), ice varchar(255), if_client varchar(255), nom varchar(255) not null, prenom varchar(255), rc varchar(255), telephone varchar(255) not null, primary key (id))
Hibernate: create table facture (date date not null, montant_ht float(53) not null, montant_tr float(53) not null, montant_ttc float(53) not null, montant_tva float(53) not null, client_id bigint not null, date_transmission timestamp(6), id bigint generated by default as identity, numero varchar(255) not null unique, transmission_statut varchar(255), statut enum ('ANNULEE','BROUILLON','PAYEE','VALIDEE') not null, primary key (id))
Hibernate: create table ligne_facture (montant_ht float(53) not null, montant_tr float(53) not null, montant_ttc float(53) not null, montant_tva float(53) not null, prix_unitaire float(53) not null, quantite float(53) not null, taux_tr float(53) not null, taux_tva float(53) not null, facture_id bigint not null, id bigint generated by default as identity, prestation_id bigint not null, primary key (id))
Hibernate: create table lignes_bulletin (quantite float(53) not null, bulletin_id bigint not null, id bigint generated by default as identity, prestation_id bigint, categorie varchar(255), code_activite varchar(255), code_port varchar(255), nature_activite varchar(255), type_terrain varchar(255), primary key (id))
Hibernate: create table prestations (taux_tr float(53) not null, taux_tva float(53) not null, id bigint generated by default as identity, code varchar(255) not null unique, compte_comptable varchar(255) not null, libelle varchar(255) not null, primary key (id))
Hibernate: create table roles (id bigint generated by default as identity, name varchar(255) not null unique, primary key (id))
Hibernate: create table tarifs_autorisation (actif boolean not null, annee_debut_revision integer, annee_tarif integer not null, delai_revision integer, montant float(53) not null, taux_revision float(53), id bigint generated by default as identity, prestation_id bigint not null, libelle varchar(255) not null, primary key (id))
Hibernate: create table tarifs_concession (actif boolean not null, annee_debut_revision integer, annee_tarif integer not null, delai_revision integer, montant float(53) not null, taux_revision float(53), id bigint generated by default as identity, prestation_id bigint not null, type_contrat varchar(255) not null, primary key (id))
Hibernate: create table tarifs_eau_electricite (actif boolean not null, annee_debut_revision integer, annee_tarif integer not null, delai_revision integer, tarif_distributeur float(53) not null check (tarif_distributeur>=0), tarif_facture float(53) not null check (tarif_facture>=0), taux_revision float(53), id bigint generated by default as identity, prestation_id bigint not null, code_activite varchar(255) not null, code_port varchar(255) not null, libelle varchar(255) not null, primary key (id))
Hibernate: create table tarifs_otdp (actif boolean not null, annee_debut_revision integer, annee_tarif integer not null, delai_revision integer, montant float(53) not null check (montant>=0), taux_revision float(53), id bigint generated by default as identity, prestation_id bigint not null, categorie varchar(255) not null, nature_activite varchar(255) not null, type_terrain varchar(255) not null, unite_base varchar(255), primary key (id))
Hibernate: create table user_roles (role_id bigint not null, user_username varchar(255) not null, primary key (role_id, user_username))
Hibernate: alter table if exists bulletins add constraint FK9bnj5qxsvwanm3o5a7vrjatlm foreign key (client_id) references client
Hibernate: alter table if exists facture add constraint FKkimq62662qs9wrpfvsw8mcnvf foreign key (client_id) references client
Hibernate: alter table if exists ligne_facture add constraint FKsqu9tafl4p72j8lym8xl42kg1 foreign key (facture_id) references facture
Hibernate: alter table if exists ligne_facture add constraint FKp5khpft8ccq619fapfr70bj73 foreign key (prestation_id) references prestations
Hibernate: alter table if exists lignes_bulletin add constraint FKaqvy73wjb0l4da5x9iaj6ekx7 foreign key (bulletin_id) references bulletins
Hibernate: alter table if exists tarifs_autorisation add constraint FK8vr0ify9p5ak18vod4cofrgq0 foreign key (prestation_id) references prestations
Hibernate: alter table if exists tarifs_concession add constraint FKq4g82ujcqrifpqd1xhreu3i1j foreign key (prestation_id) references prestations
Hibernate: alter table if exists tarifs_eau_electricite add constraint FKrtpw2srdateowjbammbarv9n0 foreign key (prestation_id) references prestations
Hibernate: alter table if exists tarifs_otdp add constraint FK97mtm39khk16kcu98tow9meqt foreign key (prestation_id) references prestations
Hibernate: alter table if exists user_roles add constraint FKh8ciramu9cc9q3qcqiv4ue8a6 foreign key (role_id) references roles
Hibernate: alter table if exists user_roles add constraint FKsjatvdmbqvtvrna5u1gaaueit foreign key (user_username) references app_users

MockHttpServletRequest:
      HTTP Method = POST
      Request URI = /api/auth/login
       Parameters = {}
          Headers = [Content-Type:"application/json;charset=UTF-8", Content-Length:"72"]
             Body = {"username":"admin","password":"admin","provider":"local","domain":null}
    Session Attrs = {}

Handler:
             Type = org.anpfacturationbackend.controller.AuthController
           Method = org.anpfacturationbackend.controller.AuthController#authenticateUser(LoginRequest)

Async:
    Async started = false
     Async result = null

Resolved Exception:
             Type = jakarta.servlet.ServletException

ModelAndView:
        View name = null
             View = null
            Model = null

FlashMap:
       Attributes = null

MockHttpServletResponse:
           Status = 500
    Error message = null
          Headers = [Vary:"Origin", "Access-Control-Request-Method", "Access-Control-Request-Headers", Content-Type:"application/json", X-Content-Type-Options:"nosniff", X-XSS-Protection:"0", Cache-Control:"no-cache, no-store, max-age=0, must-revalidate", Pragma:"no-cache", Expires:"0", X-Frame-Options:"DENY", Content-Security-Policy:"default-src 'self'; script-src 'self' http://localhost:4200 http://localhost:8088; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:; connect-src 'self' http://localhost:8080 http://localhost:4200 http://localhost:8088 ws://localhost:4200"]
     Content type = application/json
             Body = {"error":"Internal Server Error","message":"An unexpected error occurred: Handler dispatch failed: java.lang.StackOverflowError","timestamp":"2026-02-02T16:46:05.9710009","status":500}
    Forwarded URL = null
   Redirected URL = null
          Cookies = []

MockHttpServletRequest:
      HTTP Method = POST
      Request URI = /api/auth/login
       Parameters = {}
          Headers = [Content-Type:"application/json;charset=UTF-8", Content-Length:"80"]
             Body = {"username":"admin","password":"wrongpassword","provider":"local","domain":null}
    Session Attrs = {}

Handler:
             Type = org.anpfacturationbackend.controller.AuthController
           Method = org.anpfacturationbackend.controller.AuthController#authenticateUser(LoginRequest)

Async:
    Async started = false
     Async result = null

Resolved Exception:
             Type = jakarta.servlet.ServletException

ModelAndView:
        View name = null
             View = null
            Model = null

FlashMap:
       Attributes = null

MockHttpServletResponse:
           Status = 500
    Error message = null
          Headers = [Vary:"Origin", "Access-Control-Request-Method", "Access-Control-Request-Headers", Content-Type:"application/json", X-Content-Type-Options:"nosniff", X-XSS-Protection:"0", Cache-Control:"no-cache, no-store, max-age=0, must-revalidate", Pragma:"no-cache", Expires:"0", X-Frame-Options:"DENY", Content-Security-Policy:"default-src 'self'; script-src 'self' http://localhost:4200 http://localhost:8088; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:; connect-src 'self' http://localhost:8080 http://localhost:4200 http://localhost:8088 ws://localhost:4200"]
     Content type = application/json
             Body = {"error":"Internal Server Error","message":"An unexpected error occurred: Handler dispatch failed: java.lang.StackOverflowError","timestamp":"2026-02-02T16:46:06.355716","status":500}
    Forwarded URL = null
   Redirected URL = null
          Cookies = []
[ERROR] Tests run: 2, Failures: 2, Errors: 0, Skipped: 0, Time elapsed: 28.65 s <<< FAILURE! -- in org.anpfacturationbackend.controller.AuthControllerIntegrationTest
[ERROR] org.anpfacturationbackend.controller.AuthControllerIntegrationTest.testLoginSuccess -- Time elapsed: 1.314 s <<< FAILURE!
java.lang.AssertionError: Status expected:<200> but was:<500>
	at org.springframework.test.util.AssertionErrors.fail(AssertionErrors.java:61)
	at org.springframework.test.util.AssertionErrors.assertEquals(AssertionErrors.java:128)
	at org.springframework.test.web.servlet.result.StatusResultMatchers.lambda$matcher$9(StatusResultMatchers.java:640)
	at org.springframework.test.web.servlet.MockMvc$1.andExpect(MockMvc.java:214)
	at org.anpfacturationbackend.controller.AuthControllerIntegrationTest.testLoginSuccess(AuthControllerIntegrationTest.java:42)
	at java.base/java.lang.reflect.Method.invoke(Method.java:565)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)

[ERROR] org.anpfacturationbackend.controller.AuthControllerIntegrationTest.testLoginFailure -- Time elapsed: 0.261 s <<< FAILURE!
java.lang.AssertionError: Status expected:<401> but was:<500>
	at org.springframework.test.util.AssertionErrors.fail(AssertionErrors.java:61)
	at org.springframework.test.util.AssertionErrors.assertEquals(AssertionErrors.java:128)
	at org.springframework.test.web.servlet.result.StatusResultMatchers.lambda$matcher$9(StatusResultMatchers.java:640)
	at org.springframework.test.web.servlet.MockMvc$1.andExpect(MockMvc.java:214)
	at org.anpfacturationbackend.controller.AuthControllerIntegrationTest.testLoginFailure(AuthControllerIntegrationTest.java:57)
	at java.base/java.lang.reflect.Method.invoke(Method.java:565)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)

[INFO] 
[INFO] Results:
[INFO] 
[ERROR] Failures: 
[ERROR]   AuthControllerIntegrationTest.testLoginFailure:57 Status expected:<401> but was:<500>
[ERROR]   AuthControllerIntegrationTest.testLoginSuccess:42 Status expected:<200> but was:<500>
[INFO] 
[ERROR] Tests run: 2, Failures: 2, Errors: 0, Skipped: 0
[INFO] 
[INFO] ------------------------------------------------------------------------
[INFO] BUILD FAILURE
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  35.751 s
[INFO] Finished at: 2026-02-02T16:46:06+01:00
[INFO] ------------------------------------------------------------------------
[ERROR] Failed to execute goal org.apache.maven.plugins:maven-surefire-plugin:3.5.4:test (default-test) on project anp-facturation-backend: There are test failures.
[ERROR] 
[ERROR] See C:\Users\Serab\Desktop\projet youssef\anp-facturation-backend\target\surefire-reports for the individual test results.
[ERROR] See dump files (if any exist) [date].dump, [date]-jvmRun[N].dump and [date].dumpstream.
[ERROR] -> [Help 1]
[ERROR] 
[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.
[ERROR] Re-run Maven using the -X switch to enable full debug logging.
[ERROR] 
[ERROR] For more information about the errors and possible solutions, please read the following articles:
[ERROR] [Help 1] http://cwiki.apache.org/confluence/display/MAVEN/MojoFailureException
