<div class="container-fluid p-4">
  <!-- Header -->
  <header class="d-flex justify-content-between align-items-center mb-5">
    <div>
      <h1 class="h3 fw-bold text-anp-blue mb-1">Tableau de Bord</h1>
      <p class="text-muted mb-0">Vue d'ensemble de l'activité de facturation</p>
    </div>
    <div *ngIf="(authService.hasAnyRole(['ADMIN_SYSTEME', 'GESTIONNAIRE_PARAM']) | async)" class="d-flex gap-2">
      <button class="btn btn-outline-primary shadow-sm-soft" (click)="exportToCsv()">
        <i class="fas fa-file-export me-2"></i> Exporter
      </button>
      <button class="btn btn-primary shadow-sm-soft" *ngIf="isAdmin$ | async" (click)="triggerRevision()">
        <i class="fas fa-sync-alt me-2"></i> Révision Annuelle
      </button>
    </div>
  </header>

  <!-- KPIs -->
  <div class="row g-4 mb-5">
    <!-- Total HT -->
    <div class="col-xl-3 col-md-6">
      <div class="card h-100 border-0 shadow-sm-soft position-relative overflow-hidden">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <p class="text-muted text-uppercase fw-bold small mb-1">Total HT</p>
              <h3 class="fw-bold text-dark mb-0">{{ totalHt | number:'1.2-2' }} <small class="text-muted fs-6">DH</small></h3>
            </div>
            <div class="p-3 bg-primary bg-opacity-10 rounded-3 text-primary">
              <i class="fas fa-file-invoice-dollar fa-lg"></i>
            </div>
          </div>
          <div class="small text-muted">
            <i class="fas fa-arrow-up text-success me-1"></i> <span class="text-success fw-bold">12%</span> depuis le mois dernier
          </div>
        </div>
      </div>
    </div>

    <!-- Total TR -->
    <div class="col-xl-3 col-md-6">
      <div class="card h-100 border-0 shadow-sm-soft">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <p class="text-muted text-uppercase fw-bold small mb-1">Total TR</p>
              <h3 class="fw-bold text-dark mb-0">{{ totalTr | number:'1.2-2' }} <small class="text-muted fs-6">DH</small></h3>
            </div>
            <div class="p-3 bg-info bg-opacity-10 rounded-3 text-info">
              <i class="fas fa-percentage fa-lg"></i>
            </div>
          </div>
          <div class="small text-muted">
             Taux de rendement
          </div>
        </div>
      </div>
    </div>

    <!-- Total TVA -->
    <div class="col-xl-3 col-md-6">
      <div class="card h-100 border-0 shadow-sm-soft">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <p class="text-muted text-uppercase fw-bold small mb-1">Total TVA</p>
              <h3 class="fw-bold text-dark mb-0">{{ totalTva | number:'1.2-2' }} <small class="text-muted fs-6">DH</small></h3>
            </div>
            <div class="p-3 bg-warning bg-opacity-10 rounded-3 text-warning">
              <i class="fas fa-hand-holding-usd fa-lg"></i>
            </div>
          </div>
          <div class="small text-muted">
            Taxe sur la valeur ajoutée
          </div>
        </div>
      </div>
    </div>

    <!-- Total TTC -->
    <div class="col-xl-3 col-md-6">
      <div class="card h-100 border-0 shadow-sm-soft bg-primary text-white" style="background: linear-gradient(135deg, var(--anp-blue), var(--anp-blue-light));">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <p class="text-white-50 text-uppercase fw-bold small mb-1">Total TTC</p>
              <h3 class="fw-bold text-white mb-0">{{ totalTtc | number:'1.2-2' }} <small class="text-white-50 fs-6">DH</small></h3>
            </div>
            <div class="p-3 bg-white bg-opacity-25 rounded-3 text-white">
              <i class="fas fa-coins fa-lg"></i>
            </div>
          </div>
          <div class="small text-white-50">
            Chiffre d'affaires global
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts & Stats Row -->
  <div class="row g-4 mb-5">
    <!-- Status Distribution -->
    <div class="col-lg-5">
      <div class="card h-100 shadow-sm-soft">
        <div class="card-header border-0 bg-white pt-4 pb-0">
          <h5 class="card-title mb-0">État des Factures</h5>
        </div>
        <div class="card-body pt-4">
          
          <!-- Brouillon -->
          <div class="mb-4">
            <div class="d-flex justify-content-between mb-2">
              <span class="fw-medium text-muted"><i class="fas fa-file-alt me-2 text-secondary"></i>Brouillons</span>
              <span class="fw-bold text-dark">{{ statusTotals['BROUILLON'] | number:'1.0-0' }} DH</span>
            </div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar bg-secondary" role="progressbar" 
                   [style.width.%]="(statusTotals['BROUILLON'] / (totalTtc || 1)) * 100"></div>
            </div>
            <div class="mt-1 small text-muted">{{ statusCounts['BROUILLON'] }} factures</div>
          </div>

          <!-- Validée -->
          <div class="mb-4">
            <div class="d-flex justify-content-between mb-2">
              <span class="fw-medium text-muted"><i class="fas fa-check-circle me-2 text-primary"></i>Validées</span>
              <span class="fw-bold text-dark">{{ statusTotals['VALIDEE'] | number:'1.0-0' }} DH</span>
            </div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar bg-primary" role="progressbar" 
                   [style.width.%]="(statusTotals['VALIDEE'] / (totalTtc || 1)) * 100"></div>
            </div>
            <div class="mt-1 small text-muted">{{ statusCounts['VALIDEE'] }} factures</div>
          </div>

          <!-- Payée -->
          <div>
            <div class="d-flex justify-content-between mb-2">
              <span class="fw-medium text-muted"><i class="fas fa-money-bill-wave me-2 text-success"></i>Payées</span>
              <span class="fw-bold text-dark">{{ statusTotals['PAYEE'] | number:'1.0-0' }} DH</span>
            </div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar bg-success" role="progressbar" 
                   [style.width.%]="(statusTotals['PAYEE'] / (totalTtc || 1)) * 100"></div>
            </div>
            <div class="mt-1 small text-muted">{{ statusCounts['PAYEE'] }} factures</div>
          </div>

        </div>
      </div>
    </div>

    <!-- Evolution Chart (Placeholder for now) -->
    <div class="col-lg-7">
      <div class="card h-100 shadow-sm-soft">
        <div class="card-header border-0 bg-white pt-4 pb-0 d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Évolution Mensuelle</h5>
          <select class="form-select form-select-sm w-auto border-0 bg-light text-muted fw-bold">
            <option>Cette année</option>
            <option>2025</option>
          </select>
        </div>
        <div class="card-body d-flex align-items-end justify-content-around px-5 pb-5 pt-5" style="min-height: 300px;">
          <!-- CSS Bar Chart Simulation -->
           <div class="text-center w-100" *ngIf="factures.length === 0">
             <p class="text-muted">Aucune donnée disponible pour le graphique</p>
           </div>
           
           <!-- Simulated Bars (Static for visual proof, in real app we'd iterate) -->
           <ng-container *ngIf="factures.length > 0">
              <div class="d-flex flex-column align-items-center" style="height: 100%; justify-content: flex-end; width: 10%;">
                <div class="bg-primary bg-opacity-25 rounded-top w-100" style="height: 40%;"></div>
                <small class="mt-2 text-muted fw-bold">Jan</small>
              </div>
              <div class="d-flex flex-column align-items-center" style="height: 100%; justify-content: flex-end; width: 10%;">
                <div class="bg-primary bg-opacity-50 rounded-top w-100" style="height: 65%;"></div>
                <small class="mt-2 text-muted fw-bold">Fév</small>
              </div>
              <div class="d-flex flex-column align-items-center" style="height: 100%; justify-content: flex-end; width: 10%;">
                <div class="bg-primary rounded-top w-100" style="height: 85%;"></div>
                <small class="mt-2 text-muted fw-bold">Mar</small>
              </div>
               <div class="d-flex flex-column align-items-center" style="height: 100%; justify-content: flex-end; width: 10%;">
                <div class="bg-primary bg-opacity-75 rounded-top w-100" style="height: 55%;"></div>
                <small class="mt-2 text-muted fw-bold">Avr</small>
              </div>
               <div class="d-flex flex-column align-items-center" style="height: 100%; justify-content: flex-end; width: 10%;">
                <div class="bg-primary bg-opacity-25 rounded-top w-100" style="height: 30%;"></div>
                <small class="mt-2 text-muted fw-bold">Mai</small>
              </div>
           </ng-container>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Invoices Table -->
  <div class="card shadow-sm-soft">
    <div class="card-header border-0 bg-white pt-4 pb-3 d-flex justify-content-between align-items-center">
      <h5 class="card-title mb-0">Factures Récentes</h5>
      <a routerLink="/factures" class="btn btn-sm btn-light text-primary fw-bold">Tout voir</a>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="bg-light">
          <tr>
            <th class="ps-4">Numéro</th>
            <th>Client</th>
            <th>Date</th>
            <th class="text-end">Montant TTC</th>
            <th class="text-center">Statut</th>
            <th class="text-end pe-4">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let f of filteredFactures | slice:0:5">
            <td class="ps-4 fw-bold text-anp-blue">{{ f.numero || 'BROUILLON' }}</td>
            <td>
              <div class="d-flex align-items-center">
                <div class="avatar-initials bg-light text-primary rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-size: 0.8rem; font-weight: bold;">
                  {{ f.clientNom ? f.clientNom.charAt(0) : '?' }}
                </div>
                {{ f.clientNom }}
              </div>
            </td>
            <td class="text-muted">{{ f.date | date:'dd/MM/yyyy' }}</td>
            <td class="text-end fw-bold">{{ f.montantTtc | number:'1.2-2' }} DH</td>
            <td class="text-center">
              <span class="badge" 
                [ngClass]="{
                  'bg-secondary-subtle text-secondary': f.statut === 'BROUILLON',
                  'bg-primary-subtle text-primary': f.statut === 'VALIDEE',
                  'bg-success-subtle text-success': f.statut === 'PAYEE'
                }">
                {{ f.statut }}
              </span>
            </td>
            <td class="text-end pe-4">
              <button class="btn btn-sm btn-icon btn-light text-muted" title="Détails" [routerLink]="['/factures', f.id]">
                <i class="fas fa-eye"></i>
              </button>
            </td>
          </tr>
          <tr *ngIf="filteredFactures.length === 0">
            <td colspan="6" class="text-center py-5 text-muted">Aucune facture récente</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal logic (kept from original but hidden/handled by component) -->
<!-- ... -->
